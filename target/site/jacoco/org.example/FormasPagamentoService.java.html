<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FormasPagamentoService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">FormasPagamentoService</a> &gt; <a href="index.source.html" class="el_package">org.example</a> &gt; <span class="el_source">FormasPagamentoService.java</span></div><h1>FormasPagamentoService.java</h1><pre class="source lang-java linenums">package org.example;

import org.example.config.Parametros;
import org.example.model.Cliente;
import org.example.model.Pagamento;
import org.example.model.Pedido;

import java.time.LocalDate;
import java.time.Period;
import java.util.*;

public class FormasPagamentoService {

    private final Parametros parametros;
    private final PedidoService pedidoService;
    private final PagamentoService pagamentoService;

    public FormasPagamentoService(PedidoService pedidoService, PagamentoService pagamentoService,
<span class="fc" id="L19">                                  Parametros parametros) {</span>
<span class="fc" id="L20">        this.pedidoService = pedidoService;</span>
<span class="fc" id="L21">        this.pagamentoService = pagamentoService;</span>
<span class="fc" id="L22">        this.parametros = parametros;</span>
<span class="fc" id="L23">    }</span>

    public List&lt;String&gt; verificarFormasPagamento(Cliente cliente, Double valorEntrada, Double valorPedido) {

<span class="pc bpc" id="L27" title="1 of 2 branches missed.">        if (cliente == null) {</span>
<span class="nc" id="L28">            throw new IllegalArgumentException(&quot;verificarFormasPagamento: Cliente não pode ser null&quot;);</span>
        }

<span class="pc bpc" id="L31" title="1 of 2 branches missed.">        if (valorEntrada == null) {</span>
<span class="nc" id="L32">            throw new IllegalArgumentException(&quot;verificarFormasPagamento: Valor entrada não pode ser null&quot;);</span>
        }

<span class="pc bpc" id="L35" title="1 of 2 branches missed.">        if (valorPedido == null) {</span>
<span class="nc" id="L36">            throw new IllegalArgumentException(&quot;verificarFormasPagamento: Valor do pedido não pode ser null&quot;);</span>
        }

<span class="pc bpc" id="L39" title="1 of 2 branches missed.">        if (valorPedido &lt; 0) {</span>
<span class="nc" id="L40">            throw new IllegalArgumentException(&quot;verificarFormasPagamento: Valor do pedido inválido&quot;);</span>
        }

<span class="pc bpc" id="L43" title="2 of 4 branches missed.">        if (valorEntrada &lt; 0 || valorEntrada &gt; valorPedido) {</span>
<span class="nc" id="L44">            throw new IllegalArgumentException(&quot;verificarFormasPagamento: Valor entrada inválido&quot;);</span>
        }


<span class="fc" id="L48">        List&lt;String&gt; formasPagamento = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L49">        List&lt;Pedido&gt; pedidosCliente = pedidoService.getPedidos(cliente.getId());</span>
<span class="fc" id="L50">        Collections.sort(pedidosCliente);</span>
<span class="fc" id="L51">        List&lt;Pagamento&gt; pagamentos = pagamentoService.getPagamentosCliente(cliente.getId());</span>
<span class="fc" id="L52">        Collections.sort(pagamentos);</span>

<span class="fc" id="L54">        double valorUltimoPagamento = getUltimoPagamento(pagamentos);</span>
<span class="fc" id="L55">        double valorUltimoPedido = getValorUltimoPedido(pedidosCliente);</span>
<span class="fc" id="L56">        int tempoCliente = getTempoCliente(cliente.getDataCadastro());</span>
<span class="pc bpc" id="L57" title="1 of 2 branches missed.">        boolean valorEntradaMaiorIgual20porcento = valorEntrada &gt;= valorPedido * 0.2;</span>

<span class="fc" id="L59">        formasPagamento.add(&quot;Pagamento à vista&quot;);</span>

<span class="pc bpc" id="L61" title="2 of 4 branches missed.">        if (tempoCliente &gt;= 6 &amp;&amp; !&quot;ruim&quot;.equals(cliente.getSituacaoCredito())) {</span>
<span class="fc bfc" id="L62" title="All 2 branches covered.">            if (&quot;boa&quot;.equals(cliente.getSituacaoCredito())) {</span>
<span class="fc" id="L63">                formasPagamento.add(&quot;Pagamento em 2 vezes com juros&quot;);</span>
<span class="fc bfc" id="L64" title="All 2 branches covered.">                if (tempoCliente &gt;= 12) {</span>
<span class="fc" id="L65">                    formasPagamento.add(&quot;Pagamento em 3 vezes sem juros&quot;);</span>
                }
<span class="fc bfc" id="L67" title="All 2 branches covered.">                if (valorUltimoPedido &gt;= parametros.getValorLimiteUltimoPedido()</span>
<span class="pc bpc" id="L68" title="1 of 2 branches missed.">                    &amp;&amp; valorUltimoPagamento &gt;= parametros.getValorLimiteUltimoPagamento()) {</span>
<span class="fc" id="L69">                    formasPagamento.add(&quot;Pagamento em 6 vezes sem juros&quot;);</span>
                }
<span class="pc bpc" id="L71" title="1 of 2 branches missed.">            } else if (valorEntradaMaiorIgual20porcento) {</span>
<span class="fc" id="L72">                formasPagamento.add(&quot;Pagamento em 2 vezes com juros&quot;);</span>
            }
        }

<span class="fc" id="L76">        return formasPagamento;</span>
    }

    private double getValorUltimoPedido(List&lt;Pedido&gt; pedidosCliente) {
<span class="fc" id="L80">        double valor = 0.0;</span>
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">        if (!pedidosCliente.isEmpty()) {</span>
<span class="fc" id="L82">            valor = pedidosCliente.get(pedidosCliente.size()-1).valor;</span>
        }
<span class="fc" id="L84">        return valor;</span>
    }

    private int getTempoCliente(Date dataCadastro) {
        // Convertendo as datas para LocalDate (java.time)
<span class="fc" id="L89">        LocalDate localDateAnterior = dataCadastro.toInstant().atZone(java.time.ZoneId.systemDefault()).toLocalDate();</span>
<span class="fc" id="L90">        LocalDate localDateAtual = (new Date()).toInstant().atZone(java.time.ZoneId.systemDefault()).toLocalDate();</span>

        // Calculando a diferença entre as datas
<span class="fc" id="L93">        Period periodo = Period.between(localDateAnterior, localDateAtual);</span>

        // Convertendo a diferença em meses
<span class="fc" id="L96">        return periodo.getYears() * 12 + periodo.getMonths();</span>
    }

    private double getUltimoPagamento(List&lt;Pagamento&gt; pagamentos) {
<span class="fc" id="L100">        double valor = 0.0;</span>
<span class="fc" id="L101">        ListIterator&lt;Pagamento&gt; iterator = pagamentos.listIterator(pagamentos.size());</span>
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">        while (iterator.hasPrevious()) {</span>
<span class="fc" id="L103">            Pagamento pagamento = iterator.previous();</span>
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">            if (pagamento.liquidado) {</span>
<span class="fc" id="L105">                valor = pagamento.valor;</span>
<span class="fc" id="L106">                break;</span>
            }
<span class="nc" id="L108">        }</span>
<span class="fc" id="L109">        return valor;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>